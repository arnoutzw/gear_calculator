<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Involute Gear Generator</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0e14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0e14; --surface: #11151c; --surface2: #161d27; --surface3: #1a2332;
  --border: #243044; --border2: #2d3f56; --text: #e2e8f0; --muted: #7a8ba5;
  --accent: #3b82f6; --accent2: #60a5fa; --accent-dim: rgba(59,130,246,0.12);
  --green: #22c55e; --green-dim: rgba(34,197,94,0.12);
  --orange: #f59e0b; --orange-dim: rgba(245,158,11,0.1);
  --red: #ef4444; --purple: #a78bfa;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  --sidebar-w: 360px; --radius: 8px;
}
html, body { height: 100%; overflow: hidden; }
body { font-family: var(--font); background: var(--bg); color: var(--text); }
#app { display: flex; height: 100vh; }
#sidebar {
  width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--surface);
  border-right: 1px solid var(--border); display: flex; flex-direction: column;
  overflow-y: auto; overflow-x: hidden;
}
#sidebar::-webkit-scrollbar { width: 5px; }
#sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
#viewport { flex: 1; position: relative; background: var(--bg); cursor: grab; }
#viewport:active { cursor: grabbing; }
#viewport canvas { display: block; }
.logo {
  display: flex; align-items: center; gap: 12px;
  padding: 16px 20px; border-bottom: 1px solid var(--border);
}
.logo svg { width: 32px; height: 32px; flex-shrink: 0; }
.logo-text h1 { font-size: 15px; font-weight: 700; letter-spacing: -0.02em; line-height: 1.2; }
.logo-text span { font-size: 11px; color: var(--muted); font-weight: 400; }
.section { padding: 16px 20px; border-bottom: 1px solid var(--border); }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
.section-badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px; background: var(--accent-dim); color: var(--accent); }
.ctl { margin-bottom: 12px; }
.ctl:last-child { margin-bottom: 0; }
.ctl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
.ctl-label { font-size: 13px; font-weight: 500; color: var(--text); }
.ctl-value { font-family: var(--mono); font-size: 12px; font-weight: 500; color: var(--accent); background: var(--accent-dim); padding: 1px 8px; border-radius: 4px; min-width: 52px; text-align: center; }
.ctl-row { display: flex; align-items: center; gap: 10px; }
.ctl-row input[type="range"] { flex: 1; }
.ctl-row input[type="number"] { width: 72px; padding: 4px 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-family: var(--mono); font-size: 12px; text-align: center; outline: none; }
.ctl-row input[type="number"]:focus { border-color: var(--accent); }
input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--surface3); border-radius: 3px; outline: none; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--accent); border-radius: 50%; cursor: pointer; box-shadow: 0 0 0 3px var(--accent-dim); }
select { width: 100%; padding: 7px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 13px; font-family: var(--font); outline: none; cursor: pointer; }
select:focus { border-color: var(--accent); }
.toggle-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.toggle-row label { font-size: 13px; font-weight: 500; cursor: pointer; }
.toggle { position: relative; width: 36px; height: 20px; background: var(--surface3); border-radius: 10px; cursor: pointer; transition: background 0.2s; border: 1px solid var(--border); flex-shrink: 0; }
.toggle.active { background: var(--accent); border-color: var(--accent); }
.toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: #fff; border-radius: 50%; transition: transform 0.2s; }
.toggle.active::after { transform: translateX(16px); }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 14px; }
.info-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 12px; }
.info-item .il { color: var(--muted); }
.info-item .iv { font-family: var(--mono); font-size: 11px; font-weight: 500; }
.warn { margin-top: 10px; padding: 8px 10px; border-radius: var(--radius); font-size: 11px; line-height: 1.4; display: none; }
.warn.show { display: flex; align-items: flex-start; gap: 6px; }
.warn-orange { background: var(--orange-dim); border: 1px solid rgba(245,158,11,0.3); color: var(--orange); }
.warn-red { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: var(--red); }
.warn svg { flex-shrink: 0; margin-top: 1px; }
.export-section { padding: 16px 20px; margin-top: auto; border-top: 1px solid var(--border); }
.export-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.btn { padding: 10px 14px; border: none; border-radius: var(--radius); font-size: 13px; font-weight: 600; font-family: var(--font); cursor: pointer; transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; gap: 7px; }
.btn:active { transform: scale(0.97); }
.btn-dxf { background: var(--accent); color: #fff; grid-column: 1 / -1; }
.btn-dxf:hover { background: var(--accent2); }
.btn-svg { background: var(--green-dim); color: var(--green); border: 1px solid rgba(34,197,94,0.25); }
.btn-svg:hover { background: rgba(34,197,94,0.18); }
.btn-png { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-png:hover { background: var(--surface3); }
.canvas-controls { position: absolute; bottom: 16px; right: 16px; display: flex; gap: 6px; z-index: 10; }
.canvas-btn { width: 36px; height: 36px; border: 1px solid var(--border); background: var(--surface); border-radius: var(--radius); color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
.canvas-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--border2); }
.canvas-info { position: absolute; top: 16px; left: 16px; z-index: 10; font-size: 11px; color: var(--muted); font-family: var(--mono); background: rgba(10,14,20,0.85); padding: 6px 10px; border-radius: 6px; pointer-events: none; }
.canvas-legend { position: absolute; top: 16px; right: 16px; z-index: 10; background: rgba(10,14,20,0.9); padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); font-size: 11px; }
.legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.legend-item:last-child { margin-bottom: 0; }
.legend-dot { width: 10px; height: 2px; border-radius: 1px; }
#toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); padding: 10px 20px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; font-size: 13px; z-index: 200; transition: transform 0.3s ease; pointer-events: none; white-space: nowrap; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
#toast.show { transform: translateX(-50%) translateY(0); }
@media (max-width: 800px) { :root { --sidebar-w: 300px; } .export-grid { grid-template-columns: 1fr; } .btn-dxf { grid-column: 1; } }
</style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <div class="logo">
      <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <circle cx="256" cy="256" r="240" fill="#0a0e14"/>
        <path d="M256 56 l20 50 l50-15 l-5 52 l50 12 l-30 43 l40 33 l-48 22 l22 48 l-52-3 l3 52 l-50-22 l-20 50 l-20-50 l-50 22 l3-52 l-52 3 l22-48 l-48-22 l40-33 l-30-43 l50-12 l-5-52 l50 15 Z" fill="#3b82f6" fill-opacity="0.9" stroke="#3b82f6" stroke-width="2"/>
        <circle cx="256" cy="256" r="85" fill="#0a0e14"/>
        <circle cx="256" cy="256" r="28" fill="#11151c" stroke="#243044" stroke-width="3"/>
      </svg>
      <div class="logo-text">
        <h1>Involute Gear Generator</h1>
        <span>DXF / SVG export for CAD &amp; CNC</span>
      </div>
    </div>
    <div class="section">
      <div class="section-header">
        <span class="section-title">Gear Parameters</span>
        <span class="section-badge">Spur</span>
      </div>
      <div class="ctl">
        <div class="ctl-header"><span class="ctl-label">Module (mm)</span><span class="ctl-value" id="v-mod">2.0</span></div>
        <div class="ctl-row"><input type="range" id="r-mod" min="0.3" max="12" step="0.1" value="2"><input type="number" id="n-mod" min="0.1" max="50" step="0.1" value="2"></div>
      </div>
      <div class="ctl">
        <div class="ctl-header"><span class="ctl-label">Number of Teeth</span><span class="ctl-value" id="v-teeth">24</span></div>
        <div class="ctl-row"><input type="range" id="r-teeth" min="6" max="200" step="1" value="24"><input type="number" id="n-teeth" min="4" max="500" step="1" value="24"></div>
      </div>
      <div class="ctl">
        <div class="ctl-header"><span class="ctl-label">Pressure Angle</span></div>
        <select id="s-pa">
          <option value="14.5">14.5 (legacy / clocks)</option>
          <option value="20" selected>20 (standard)</option>
          <option value="25">25 (high load)</option>
        </select>
      </div>
      <div class="ctl">
        <div class="ctl-header"><span class="ctl-label">Profile Shift (x)</span><span class="ctl-value" id="v-ps">0.00</span></div>
        <div class="ctl-row"><input type="range" id="r-ps" min="-0.6" max="0.6" step="0.01" value="0"><input type="number" id="n-ps" min="-1" max="1" step="0.01" value="0"></div>
      </div>
      <div class="ctl">
        <div class="ctl-header"><span class="ctl-label">Bore Diameter (mm)</span><span class="ctl-value" id="v-bore">8.0</span></div>
        <div class="ctl-row"><input type="range" id="r-bore" min="0" max="200" step="0.5" value="8"><input type="number" id="n-bore" min="0" max="500" step="0.1" value="8"></div>
      </div>
      <div class="ctl">
        <div class="ctl-header"><span class="ctl-label">Clearance Coeff.</span><span class="ctl-value" id="v-cl">0.25</span></div>
        <div class="ctl-row"><input type="range" id="r-cl" min="0.1" max="0.4" step="0.01" value="0.25"><input type="number" id="n-cl" min="0" max="1" step="0.01" value="0.25"></div>
      </div>
      <div class="ctl">
        <div class="ctl-header"><span class="ctl-label">Profile Resolution</span><span class="ctl-value" id="v-res">40</span></div>
        <div class="ctl-row"><input type="range" id="r-res" min="10" max="100" step="5" value="40"><input type="number" id="n-res" min="5" max="200" step="1" value="40"></div>
      </div>
      <div id="warn-undercut" class="warn warn-orange">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
        <span id="warn-text"></span>
      </div>
    </div>
    <div class="section">
      <div class="section-header"><span class="section-title">Display</span></div>
      <div class="toggle-row"><div class="toggle active" id="t-pitch" data-key="showPitch"></div><label>Pitch circle</label></div>
      <div class="toggle-row"><div class="toggle active" id="t-base" data-key="showBase"></div><label>Base circle</label></div>
      <div class="toggle-row"><div class="toggle" id="t-root" data-key="showRoot"></div><label>Root circle</label></div>
      <div class="toggle-row"><div class="toggle" id="t-outer" data-key="showOuter"></div><label>Addendum circle</label></div>
      <div class="toggle-row"><div class="toggle active" id="t-dims" data-key="showDims"></div><label>Dimension labels</label></div>
    </div>
    <div class="section">
      <div class="section-header"><span class="section-title">Computed Values</span></div>
      <div class="info-grid">
        <div class="info-item"><span class="il">Pitch Dia.</span><span class="iv" id="i-pd">--</span></div>
        <div class="info-item"><span class="il">Outside Dia.</span><span class="iv" id="i-od">--</span></div>
        <div class="info-item"><span class="il">Root Dia.</span><span class="iv" id="i-rd">--</span></div>
        <div class="info-item"><span class="il">Base Dia.</span><span class="iv" id="i-bd">--</span></div>
        <div class="info-item"><span class="il">Circ. Pitch</span><span class="iv" id="i-cp">--</span></div>
        <div class="info-item"><span class="il">Tooth Thk.</span><span class="iv" id="i-tt">--</span></div>
        <div class="info-item"><span class="il">Addendum</span><span class="iv" id="i-ha">--</span></div>
        <div class="info-item"><span class="il">Dedendum</span><span class="iv" id="i-hf">--</span></div>
        <div class="info-item"><span class="il">Total Points</span><span class="iv" id="i-np">--</span></div>
        <div class="info-item"><span class="il">Undercut</span><span class="iv" id="i-uc">--</span></div>
      </div>
    </div>
    <div class="export-section">
      <div class="section-header"><span class="section-title">Export</span></div>
      <div class="export-grid">
        <button class="btn btn-dxf" id="btn-dxf">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export DXF
        </button>
        <button class="btn btn-svg" id="btn-svg">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          SVG
        </button>
        <button class="btn btn-png" id="btn-png">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          PNG
        </button>
      </div>
    </div>
  </aside>
  <main id="viewport">
    <canvas id="gearCanvas"></canvas>
    <div class="canvas-info" id="canvasInfo">Zoom: 100%</div>
    <div class="canvas-legend">
      <div class="legend-item"><div class="legend-dot" style="background:#e2e8f0"></div><span style="color:var(--muted)">Tooth profile</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#f59e0b;opacity:0.6"></div><span style="color:var(--muted)">Pitch circle</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#3b82f6;opacity:0.6"></div><span style="color:var(--muted)">Base circle</span></div>
    </div>
    <div class="canvas-controls">
      <button class="canvas-btn" id="btn-zoomfit" title="Zoom to fit"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18M3 9h18"/></svg></button>
      <button class="canvas-btn" id="btn-zoomin" title="Zoom in"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
      <button class="canvas-btn" id="btn-zoomout" title="Zoom out"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
    </div>
  </main>
</div>
<div id="toast"></div>
<script>
// INVOLUTE GEAR MATH
const GearMath={generate(p){const{module:m,teeth:z,pressureAngleDeg:paDeg,profileShift:x,clearance:c,resolution:res}=p;const alpha=paDeg*Math.PI/180;const inv=a=>Math.tan(a)-a;const rp=m*z/2;const rb=rp*Math.cos(alpha);const ra=rp+m*(1+x);const rf=Math.max(rp-m*(1+c-x),0.1);const toothThk=m*(Math.PI/2+2*x*Math.tan(alpha));const halfA=toothThk/(2*rp);const invA=inv(alpha);const angP=2*Math.PI/z;const startR=Math.max(rb,rf);const minZ=Math.ceil(2/(Math.sin(alpha)*Math.sin(alpha)));const hasUndercut=z<minZ&&x<(minZ-z)/(2*minZ);function rAngle(tc,r){if(r<=rb)return tc+halfA+invA;return tc+halfA+invA-inv(Math.acos(Math.min(rb/r,1)))}function lAngle(tc,r){if(r<=rb)return tc-halfA-invA;return tc-halfA-invA+inv(Math.acos(Math.min(rb/r,1)))}const pts=[];const rootN=Math.max(4,Math.round(res/4));const tipN=Math.max(3,Math.round(res/5));const trN=4;for(let i=0;i<z;i++){const tc=i*angP;if(rf<rb){const ba=rAngle(tc,rb);for(let j=0;j<=trN;j++){const t=j/trN;const r=rf+t*(rb-rf);pts.push([r*Math.cos(ba),r*Math.sin(ba)])}}for(let j=0;j<=res;j++){const t=j/res;const r=startR+t*(ra-startR);const a=rAngle(tc,r);pts.push([r*Math.cos(a),r*Math.sin(a)])}const rT=rAngle(tc,ra),lT=lAngle(tc,ra);for(let j=1;j<tipN;j++){const t=j/tipN;const a=rT+t*(lT-rT);pts.push([ra*Math.cos(a),ra*Math.sin(a)])}for(let j=0;j<=res;j++){const t=j/res;const r=ra-t*(ra-startR);const a=lAngle(tc,r);pts.push([r*Math.cos(a),r*Math.sin(a)])}if(rf<rb){const ba=lAngle(tc,rb);for(let j=1;j<=trN;j++){const t=j/trN;const r=rb-t*(rb-rf);pts.push([r*Math.cos(ba),r*Math.sin(ba)])}}const gs=rf<rb?lAngle(tc,rb):lAngle(tc,startR);const nTc=(i+1)*angP;const ge=rf<rb?rAngle(nTc,rb):rAngle(nTc,startR);for(let j=1;j<=rootN;j++){const t=j/rootN;const a=gs+t*(ge-gs);pts.push([rf*Math.cos(a),rf*Math.sin(a)])}}const cl=[pts[0]];for(let i=1;i<pts.length;i++){const dx=pts[i][0]-cl[cl.length-1][0],dy=pts[i][1]-cl[cl.length-1][1];if(dx*dx+dy*dy>1e-12)cl.push(pts[i])}if(cl.length>2){const dx=cl[cl.length-1][0]-cl[0][0],dy=cl[cl.length-1][1]-cl[0][1];if(dx*dx+dy*dy<1e-10)cl.pop()}return{points:cl,radii:{pitch:rp,base:rb,addendum:ra,root:rf},info:{pitchDia:2*rp,outerDia:2*ra,rootDia:2*rf,baseDia:2*rb,circPitch:Math.PI*m,toothThk,addendum:m*(1+x),dedendum:m*(1+c-x),hasUndercut,minTeethNoUndercut:minZ}}}};

// DXF EXPORT
const DXFExport={generate(pts,bore,radii){const L=[];const w=s=>L.push(s);w('0');w('SECTION');w('2');w('HEADER');w('9');w('$ACADVER');w('1');w('AC1015');w('9');w('$INSUNITS');w('70');w('4');w('9');w('$MEASUREMENT');w('70');w('1');w('0');w('ENDSEC');w('0');w('SECTION');w('2');w('TABLES');w('0');w('TABLE');w('2');w('LAYER');w('70');w('4');w('0');w('LAYER');w('2');w('GEAR_PROFILE');w('70');w('0');w('62');w('7');w('6');w('CONTINUOUS');w('0');w('LAYER');w('2');w('BORE');w('70');w('0');w('62');w('1');w('6');w('CONTINUOUS');w('0');w('LAYER');w('2');w('PITCH_CIRCLE');w('70');w('0');w('62');w('3');w('6');w('DASHDOT');w('0');w('LAYER');w('2');w('BASE_CIRCLE');w('70');w('0');w('62');w('5');w('6');w('DASHED');w('0');w('ENDTAB');w('0');w('ENDSEC');w('0');w('SECTION');w('2');w('ENTITIES');w('0');w('LWPOLYLINE');w('8');w('GEAR_PROFILE');w('90');w(String(pts.length));w('70');w('1');for(const[x,y]of pts){w('10');w(x.toFixed(6));w('20');w(y.toFixed(6))}if(bore>0){w('0');w('CIRCLE');w('8');w('BORE');w('10');w('0.000000');w('20');w('0.000000');w('40');w((bore/2).toFixed(6))}w('0');w('CIRCLE');w('8');w('PITCH_CIRCLE');w('10');w('0.000000');w('20');w('0.000000');w('40');w(radii.pitch.toFixed(6));w('0');w('CIRCLE');w('8');w('BASE_CIRCLE');w('10');w('0.000000');w('20');w('0.000000');w('40');w(radii.base.toFixed(6));w('0');w('ENDSEC');w('0');w('EOF');return L.join('\n')}};

// SVG EXPORT
const SVGExport={generate(pts,bore,radii,info){const margin=5;const ra=radii.addendum;const sz=2*ra+2*margin;let s=`<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" width="${sz.toFixed(2)}mm" height="${sz.toFixed(2)}mm" viewBox="${(-ra-margin).toFixed(4)} ${(-ra-margin).toFixed(4)} ${sz.toFixed(4)} ${sz.toFixed(4)}">\n`;s+=`<title>Involute Spur Gear z=${info.pitchDia.toFixed(1)/(radii.pitch*2)*radii.pitch*2|0}</title>\n`;let d=`M ${pts[0][0].toFixed(6)},${(-pts[0][1]).toFixed(6)}`;for(let i=1;i<pts.length;i++)d+=` L ${pts[i][0].toFixed(6)},${(-pts[i][1]).toFixed(6)}`;d+=' Z';s+=`<path d="${d}" fill="none" stroke="#000" stroke-width="0.2"/>\n`;if(bore>0)s+=`<circle cx="0" cy="0" r="${(bore/2).toFixed(6)}" fill="none" stroke="#000" stroke-width="0.2"/>\n`;s+=`<circle cx="0" cy="0" r="${radii.pitch.toFixed(6)}" fill="none" stroke="#888" stroke-width="0.1" stroke-dasharray="1,1"/>\n`;s+=`<circle cx="0" cy="0" r="${radii.base.toFixed(6)}" fill="none" stroke="#00f" stroke-width="0.1" stroke-dasharray="0.5,0.5"/>\n`;s+=`</svg>`;return s}};

// CANVAS RENDERER
const Renderer=(()=>{let canvas,ctx;let panX=0,panY=0,zoom=1;let isDrag=false,lastM={x:0,y:0};let gear=null;let dOpts={showPitch:true,showBase:true,showRoot:false,showOuter:false,showDims:true};const dpr=()=>Math.min(window.devicePixelRatio||1,2);
function init(c){canvas=c;ctx=c.getContext('2d');resize();bindEv()}
function resize(){const p=canvas.parentElement;const w=p.clientWidth,h=p.clientHeight,d=dpr();canvas.width=w*d;canvas.height=h*d;canvas.style.width=w+'px';canvas.style.height=h+'px';draw()}
function toS(wx,wy){const d=dpr(),cx=canvas.width/(2*d),cy=canvas.height/(2*d);return[(wx*zoom+panX+cx)*d,(-wy*zoom+panY+cy)*d]}
function toW(sx,sy){const d=dpr(),cx=canvas.width/(2*d),cy=canvas.height/(2*d);return[(sx/d-panX-cx)/zoom,-(sy/d-panY-cy)/zoom]}
function draw(){if(!canvas)return;const d=dpr(),w=canvas.width,h=canvas.height;ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,w,h);ctx.fillStyle='#0a0e14';ctx.fillRect(0,0,w,h);drawGrid();if(gear)drawGear();updateInfo()}
function drawGrid(){const d=dpr(),w=canvas.width/d,h=canvas.height/d;const raw=50/zoom,mag=Math.pow(10,Math.floor(Math.log10(raw))),norm=raw/mag;let sp;if(norm<2)sp=mag;else if(norm<5)sp=2*mag;else sp=5*mag;const mSp=sp/5;const[wx0,wy0]=toW(0,0),[wx1,wy1]=toW(w*d,h*d);const mnX=Math.min(wx0,wx1),mxX=Math.max(wx0,wx1),mnY=Math.min(wy0,wy1),mxY=Math.max(wy0,wy1);if(mSp*zoom>4){ctx.strokeStyle='rgba(36,48,68,0.3)';ctx.lineWidth=0.5*d;ctx.beginPath();for(let x=Math.floor(mnX/mSp)*mSp;x<=mxX;x+=mSp){const[sx]=toS(x,0);ctx.moveTo(sx,0);ctx.lineTo(sx,h*d)}for(let y=Math.floor(mnY/mSp)*mSp;y<=mxY;y+=mSp){const[,sy]=toS(0,y);ctx.moveTo(0,sy);ctx.lineTo(w*d,sy)}ctx.stroke()}ctx.strokeStyle='rgba(36,48,68,0.7)';ctx.lineWidth=0.8*d;ctx.beginPath();for(let x=Math.floor(mnX/sp)*sp;x<=mxX;x+=sp){const[sx]=toS(x,0);ctx.moveTo(sx,0);ctx.lineTo(sx,h*d)}for(let y=Math.floor(mnY/sp)*sp;y<=mxY;y+=sp){const[,sy]=toS(0,y);ctx.moveTo(0,sy);ctx.lineTo(w*d,sy)}ctx.stroke();const[ox,oy]=toS(0,0);ctx.strokeStyle='rgba(122,139,165,0.3)';ctx.lineWidth=1*d;ctx.beginPath();ctx.moveTo(ox,0);ctx.lineTo(ox,h*d);ctx.moveTo(0,oy);ctx.lineTo(w*d,oy);ctx.stroke();ctx.fillStyle='rgba(122,139,165,0.5)';ctx.beginPath();ctx.arc(ox,oy,3*d,0,Math.PI*2);ctx.fill();if(dOpts.showDims){ctx.font=`${10*d}px -apple-system,sans-serif`;ctx.fillStyle='rgba(122,139,165,0.5)';ctx.textAlign='left';ctx.textBaseline='top';for(let x=Math.floor(mnX/sp)*sp;x<=mxX;x+=sp){if(Math.abs(x)<sp*0.01)continue;const[sx]=toS(x,0);ctx.fillText(fmtN(x),sx+3*d,oy+4*d)}ctx.textAlign='right';ctx.textBaseline='middle';for(let y=Math.floor(mnY/sp)*sp;y<=mxY;y+=sp){if(Math.abs(y)<sp*0.01)continue;const[,sy]=toS(0,y);ctx.fillText(fmtN(y),ox-4*d,sy)}}}
function fmtN(v){return Math.abs(v)>=1?Number(v.toFixed(1)).toString():v.toFixed(2)}
function drawGear(){const d=dpr(),{points:pts,radii:r,bore}=gear;function dCirc(rad,col,dash){const[cx,cy]=toS(0,0);ctx.strokeStyle=col;ctx.lineWidth=1*d;ctx.setLineDash(dash.map(v=>v*d));ctx.beginPath();ctx.arc(cx,cy,rad*zoom*d,0,Math.PI*2);ctx.stroke();ctx.setLineDash([])}if(dOpts.showRoot)dCirc(r.root,'rgba(239,68,68,0.4)',[4,3]);if(dOpts.showBase)dCirc(r.base,'rgba(59,130,246,0.45)',[3,3]);if(dOpts.showPitch)dCirc(r.pitch,'rgba(245,158,11,0.5)',[6,3]);if(dOpts.showOuter)dCirc(r.addendum,'rgba(167,139,250,0.4)',[4,3]);ctx.beginPath();const[fx,fy]=toS(pts[0][0],pts[0][1]);ctx.moveTo(fx,fy);for(let i=1;i<pts.length;i++){const[px,py]=toS(pts[i][0],pts[i][1]);ctx.lineTo(px,py)}ctx.closePath();ctx.fillStyle='rgba(226,232,240,0.04)';ctx.fill();ctx.strokeStyle='rgba(226,232,240,0.85)';ctx.lineWidth=1.5*d;ctx.stroke();if(bore>0){const[cx,cy]=toS(0,0);ctx.strokeStyle='rgba(226,232,240,0.6)';ctx.lineWidth=1.2*d;ctx.beginPath();ctx.arc(cx,cy,bore/2*zoom*d,0,Math.PI*2);ctx.stroke()}if(dOpts.showDims){const la=Math.PI*0.28;function dimL(rad,lbl,col){const[lx,ly]=toS(rad*Math.cos(la),rad*Math.sin(la));ctx.font=`500 ${10*d}px -apple-system,sans-serif`;ctx.fillStyle=col;ctx.textAlign='left';ctx.textBaseline='bottom';ctx.fillText(lbl+' \u2300'+(2*rad).toFixed(2),lx+5*d,ly-3*d)}if(dOpts.showPitch)dimL(r.pitch,'PD','rgba(245,158,11,0.7)');if(dOpts.showBase)dimL(r.base,'BD','rgba(59,130,246,0.6)');if(dOpts.showRoot)dimL(r.root,'RD','rgba(239,68,68,0.6)');if(dOpts.showOuter)dimL(r.addendum,'OD','rgba(167,139,250,0.6)')}}
function updateInfo(){document.getElementById('canvasInfo').textContent='Zoom: '+(zoom*100).toFixed(0)+'%'}
function zoomToFit(){if(!gear)return;const ra=gear.radii.addendum,d=dpr(),w=canvas.width/d,h=canvas.height/d,pad=60;zoom=Math.min((w-pad)/(2*ra),(h-pad)/(2*ra));panX=0;panY=0;draw()}
function bindEv(){canvas.addEventListener('wheel',e=>{e.preventDefault();const f=e.deltaY>0?0.9:1.1;const d=dpr(),rect=canvas.getBoundingClientRect();const mx=e.clientX-rect.left,my=e.clientY-rect.top;const cx=canvas.width/(2*d),cy=canvas.height/(2*d);const wx=(mx-panX-cx)/zoom,wy=-(my-panY-cy)/zoom;zoom*=f;zoom=Math.max(0.01,Math.min(zoom,500));panX=mx-cx-wx*zoom;panY=my-cy+wy*zoom;draw()},{passive:false});canvas.addEventListener('mousedown',e=>{isDrag=true;lastM={x:e.clientX,y:e.clientY}});window.addEventListener('mousemove',e=>{if(!isDrag)return;panX+=e.clientX-lastM.x;panY+=e.clientY-lastM.y;lastM={x:e.clientX,y:e.clientY};draw()});window.addEventListener('mouseup',()=>{isDrag=false});let ltd=null;canvas.addEventListener('touchstart',e=>{if(e.touches.length===1){isDrag=true;lastM={x:e.touches[0].clientX,y:e.touches[0].clientY}}else if(e.touches.length===2){isDrag=false;const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;ltd=Math.sqrt(dx*dx+dy*dy)}e.preventDefault()},{passive:false});canvas.addEventListener('touchmove',e=>{if(e.touches.length===1&&isDrag){panX+=e.touches[0].clientX-lastM.x;panY+=e.touches[0].clientY-lastM.y;lastM={x:e.touches[0].clientX,y:e.touches[0].clientY};draw()}else if(e.touches.length===2&&ltd!==null){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;const dist=Math.sqrt(dx*dx+dy*dy);zoom*=dist/ltd;zoom=Math.max(0.01,Math.min(zoom,500));ltd=dist;draw()}e.preventDefault()},{passive:false});canvas.addEventListener('touchend',()=>{isDrag=false;ltd=null});window.addEventListener('resize',resize)}
function setGear(g,b){gear={...g,bore:b};draw()}
function setDO(k,v){dOpts[k]=v;draw()}
return{init,setGear,setDisplayOpt:setDO,zoomToFit,zoomIn(){zoom*=1.3;draw()},zoomOut(){zoom*=0.77;draw()},draw,resize,getCanvas(){return canvas}}})();

// APP CONTROLLER
(function(){const $=s=>document.querySelector(s);let result=null,params={};
function toast(m){const e=$('#toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2500)}
function dl(c,fn,mime){const b=typeof c==='string'?new Blob([c],{type:mime}):c;const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=fn;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(u);a.remove()},100)}
function bindCtl(rId,nId,vId,fmt){const r=$(rId),n=$(nId),v=$(vId);function sync(src){const val=parseFloat(src.value);if(isNaN(val))return;if(src===r)n.value=val;else r.value=Math.max(r.min,Math.min(r.max,val));v.textContent=fmt(val);updateGear()}r.addEventListener('input',()=>sync(r));n.addEventListener('input',()=>sync(n));n.addEventListener('change',()=>sync(n))}
function readP(){return{module:parseFloat($('#n-mod').value)||2,teeth:parseInt($('#n-teeth').value)||24,pressureAngleDeg:parseFloat($('#s-pa').value),profileShift:parseFloat($('#n-ps').value)||0,bore:parseFloat($('#n-bore').value)||0,clearance:parseFloat($('#n-cl').value)||0.25,resolution:parseInt($('#n-res').value)||40}}
function updateGear(){params=readP();const rp=params.module*params.teeth/2;const rf=Math.max(rp-params.module*(1+params.clearance-params.profileShift),0.1);const maxB=2*rf-0.5;if(params.bore>maxB&&maxB>0){params.bore=Math.max(0,Math.round(maxB*10)/10);$('#r-bore').value=params.bore;$('#n-bore').value=params.bore;$('#v-bore').textContent=params.bore.toFixed(1)}result=GearMath.generate(params);const{info,points}=result;const mm=v=>v.toFixed(3);$('#i-pd').textContent=mm(info.pitchDia);$('#i-od').textContent=mm(info.outerDia);$('#i-rd').textContent=mm(info.rootDia);$('#i-bd').textContent=mm(info.baseDia);$('#i-cp').textContent=mm(info.circPitch);$('#i-tt').textContent=mm(info.toothThk);$('#i-ha').textContent=mm(info.addendum);$('#i-hf').textContent=mm(info.dedendum);$('#i-np').textContent=points.length;$('#i-uc').textContent=info.hasUndercut?'Yes':'No';$('#i-uc').style.color=info.hasUndercut?'#ef4444':'#22c55e';const warn=$('#warn-undercut'),wt=$('#warn-text');if(info.toothThk<=0){wt.textContent='Tooth thickness is zero or negative. Reduce profile shift.';warn.classList.add('show');warn.className='warn warn-red show'}else if(info.hasUndercut){wt.textContent='Undercut will occur. Min '+info.minTeethNoUndercut+' teeth needed at this pressure angle, or increase profile shift.';warn.classList.add('show');warn.className='warn warn-orange show'}else if(params.bore>=2*rf){wt.textContent='Bore diameter exceeds root circle.';warn.classList.add('show');warn.className='warn warn-red show'}else{warn.classList.remove('show')}Renderer.setGear(result,params.bore)}
function init(){Renderer.init($('#gearCanvas'));bindCtl('#r-mod','#n-mod','#v-mod',v=>v.toFixed(1));bindCtl('#r-teeth','#n-teeth','#v-teeth',v=>String(Math.round(v)));bindCtl('#r-ps','#n-ps','#v-ps',v=>v.toFixed(2));bindCtl('#r-bore','#n-bore','#v-bore',v=>v.toFixed(1));bindCtl('#r-cl','#n-cl','#v-cl',v=>v.toFixed(2));bindCtl('#r-res','#n-res','#v-res',v=>String(Math.round(v)));$('#s-pa').addEventListener('change',updateGear);document.querySelectorAll('.toggle').forEach(el=>{el.addEventListener('click',()=>{el.classList.toggle('active');Renderer.setDisplayOpt(el.dataset.key,el.classList.contains('active'))})});$('#btn-zoomfit').addEventListener('click',()=>Renderer.zoomToFit());$('#btn-zoomin').addEventListener('click',()=>Renderer.zoomIn());$('#btn-zoomout').addEventListener('click',()=>Renderer.zoomOut());$('#btn-dxf').addEventListener('click',()=>{if(!result)return;toast('Generating DXF...');setTimeout(()=>{const dxf=DXFExport.generate(result.points,params.bore,result.radii);dl(dxf,`gear_z${params.teeth}_m${params.module}.dxf`,'application/dxf');toast('DXF exported!')},30)});$('#btn-svg').addEventListener('click',()=>{if(!result)return;toast('Generating SVG...');setTimeout(()=>{const svg=SVGExport.generate(result.points,params.bore,result.radii,result.info);dl(svg,`gear_z${params.teeth}_m${params.module}.svg`,'image/svg+xml');toast('SVG exported!')},30)});$('#btn-png').addEventListener('click',()=>{if(!result)return;toast('Exporting PNG...');setTimeout(()=>{Renderer.getCanvas().toBlob(blob=>{dl(blob,`gear_z${params.teeth}_m${params.module}.png`,'image/png')})},30)});updateGear();requestAnimationFrame(()=>Renderer.zoomToFit())}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();if('serviceWorker'in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{})})();
</script>
</body>
</html>